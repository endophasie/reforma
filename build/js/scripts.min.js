function ajax(){return $.getJSON("data.json")}function shuffle(a){for(var e,o,r=a.length;0!==r;)o=Math.floor(Math.random()*r),r-=1,e=a[r],a[r]=a[o],a[o]=e;return a}var data=null;ajax().done(function(a){data=a;var e=$(".js-reforma-start"),o=new Reforma;o.init(),e.on("click",function(a){a.preventDefault(),o.reset()})});var Reforma=function(){var a=this,e=data.deck,o=0,r=2,s=[],n=[],i="";a.init=function(){a.reset(),_()},a.reset=function(){console.log("reset",1),o=0,r=2,s=[],n=[],i="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var a=$(".reforma-game_info-message"),e=$(".reforma-game_info-action");a.addClass("is-hide"),e.removeClass("is-hide"),$(".reforma_card").remove(),t(),shuffle(s),c(),d()};var t=function(){var a=$(".reforma-deck_card");for(var o in e){var r="",n=e[o];"economics"==n.type?r+="Экономика":"social"==n.type?r+="Социальная сфера":"war"==n.type&&(r+="Военное дело");var i=$('  <div class="reforma_card '+n.type+'" id="'+o+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+r+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+n.title+'</div>\t\t<div class="reforma_card-text">'+n.content+"</div>  \t </div>  </div>");s.push(o),a.prepend(i)}},c=function(){i=$("#"+s[0]),i.addClass("is-active").siblings(".reforma_card").removeClass("is-active")},d=function(){var a=$(".reforma-game_score");a.text(o),o>=100&&C("total-victory")},f=function(a){var e=$(".reforma-game_life");r-=1,1==r&&(e.eq(1).addClass("is-burn"),E(a)),0==r&&(e.eq(0).addClass("is-burn"),E(a),C("total-defeat"))},l=function(a){i.removeClass("is-active"),s.splice(0,1),e[a].failMessage&&f(a),console.log("putOnTable",a);var o=$(".reforma-game_col.is-economy").find(".reforma-game_content"),r=$(".reforma-game_col.is-social").find(".reforma-game_content"),t=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+a).hasClass("economics")?o.prepend($("#"+a)):$("#"+a).hasClass("social")?r.prepend($("#"+a)):$("#"+a).hasClass("war")&&t.prepend($("#"+a)),$("#"+a).addClass("on-desk"),n.push(a),0==s.length&&g()},p=function(a){if(0==n.length)console.log("first or last?",a),l(a);else{var r=e[a].relation,s=e[a].messages,i=!1;if(void 0!=r)for(key in r){var t=u(r[key]),c=m(r[key]),f=s[key],p=[];if(t){for(j in f)v(c).forEach(function(a){a==j&&p.push(a)});switch(console.log("ids",c),console.log("message",p),key){case"needs":b(a,v(c),p),$("#"+a).addClass("is-act"),o+=v(c).length,d(),i=!0;break;case"conflict":x(a,v(c),p),i=!0;break;case"option":o+=1,d()}}}i||l(a)}},m=function(a){var e=[],o=/(x|\&|\|)/g;return a.replace(o,",$1").split(/,/g).forEach(function(a){a.length&&(a[0].match(o)?id=a.substr(1):id=a,e.push(id))}),e},u=function(a){if(0==!a.length){var e=!1,o=/(x|\&|\|)/g;return a.replace(o,",$1").split(/,/g).forEach(function(r){console.log(a);var s,n="|";if(r.length){if(r[0].match(o)?(n=r[0],s=r.substr(1)):s=r,"x"==n){var i=h(s);e=e?!i:i}"&"==n&&(e&=h(s)),"|"==n&&(e|=h(s))}}),e}return!1},v=function(a){return a.filter(function(a){return h(a)})},h=function(a){var e=n.filter(function(e){return e==a});return e.length>0},_=function(){var a=$(".reforma_card");a.on("click",function(){var a=$(this).attr("id");if(console.log("infoPopupData",a),$(this).hasClass("is-act")){var o=m(e[a].relation.needs),r=v(o),s=!0;w(a,r,s),console.log("infoPopupData",a,r,s)}else w(a)});var o=$(".js-act-add"),r=$(".js-act-skip"),n=$(".js-act-remove");o.on("click",function(){var a=i.attr("id");p(a),c()}),r.on("click",function(){s.push(s.splice(0,1)[0]),c()}),n.on("click",function(){s.splice(0,1),c(),0==s.length&&(i.removeClass("is-active"),g())})},g=function(){o>=2&&C("total-victory"),o<1&&C("total-loose")},C=function(a){var e=($(".reforma-game_info-message"),$(".reforma-game_info-action"));$("."+a).removeClass("is-hide"),e.addClass("is-hide"),$(".js-total-score").text(o),$(".js-popup-info-link").on("click",function(){T(a)})},k=function(a){var e=$(".js-overlay"),o=$(".js-popup"),r=$(".js-popup-close");$(".js-popup_content-card");o.addClass("is-hide"),e.removeClass("is-hide"),$("."+a).removeClass("is-hide"),r.on("click",function(){y(a)}),$(document).on("keydown",function(e){27==e.which&&y(a)})},y=function(a){var e=$(".js-overlay"),o=$("."+a)||$(".js-popup"),r=$(".js-popup_content-card"),s=$(".reforma-popup_card-wrap");e.addClass("is-hide"),o.addClass("is-hide"),r.empty(),s.empty()},w=function(a,o,r){var s=$(".card-info").find(".js-popup_content-card"),n=$(".card-info.js-popup"),i=$(".card-info").find(".reforma-popup_card-wrap");k("card-info",r),o=o||[],$("#"+a).clone().removeClass("on-desk").attr("id","").prependTo(s),o.forEach(function(a){$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i)}),console.log("actPopup",r),r?n.addClass("card-active"):n.removeClass("card-active"),i.find(".reforma_card").on("click",function(){s.empty();var a=$(this).attr("id");if($(this).hasClass("is-act")){var o=m(e[a].relation.needs),r=v(o),n=!0;w(a,r,n)}else w(a)})},x=function(a,o,r){var s=$(".conflict").find(".js-popup_content-card"),i=$(".conflict").find(".js-popup-text");k("conflict"),o=o||[],r.forEach(function(o){var r=e[a].messages.conflict[o];i.text(data.content[r])}),$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(s),o.forEach(function(a){$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(s)}),$(".conflict").find(".reforma_card").on("click",function(){var a=$(this).attr("id"),e=$(this).siblings(".reforma_card").attr("id"),o=n.indexOf(e);o>-1&&n.splice(o,1),$("#"+e).remove(),y("conflict"),p(a),c()})},b=function(a,o,r){var s,n=$(".started-work").find(".js-popup_content-card");'<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+e[a].content+"</div></div>";k("started-work"),o=o||[],r.forEach(function(o){var r=e[a].messages.needs[o];s=data.content[r]}),o.forEach(function(a){var o='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+s+"</div></div>";n.prepend(o)}),l(a)},E=function(a){var o=$(".lost-life").find(".js-popup_content-card"),r='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+e[a].failMessage.content+"</div></div>";k("lost-life"),o.prepend(r)},T=function(a){var e,o=$(".finish.js-popup"),r=$(".finish .reforma-popup_title");k("finish"),e="total-loose"==a?"Вы проиграли":"total-defeat"==a?"У вас бунт, государь":"Виктория, государь!",o.addClass(a),r.text(e)}};