function shuffle(e){for(var a,o,s=e.length;0!==s;)o=Math.floor(Math.random()*s),s-=1,a=e[s],e[s]=e[o],e[o]=a;return e}var data={deck:{101:{type:"economics",title:"Подушная подать",content:"Обложить одинаковым налогом мужчин всех сословий, кроме дворян и церковников",relation:{conflict:"102|103"},messages:{conflict:{102:"Пополнять казну, конечно, можно разными способами, но если заставить людей платить и с души, и с двора, они разорятся.",103:"Налог может быть одинаковым для всех, а может зависеть от дохода, но он не может быть и таким, и другим одновременно; можно обязать платить всех, можно выключить из налогообложения отдельные категории населения, но сделать и то и другое одновременно опять же никак нельзя."}},failMessage:!1},102:{type:"economics",title:"Подворная подать",content:"Собирать налог не с отдельных представителей податных сословий, а с двора — то есть с крестьянского хозяйства, которое могло объединять несколько семей",relation:{conflict:"101|103"},messages:{conflict:{101:"Пополнять казну, конечно, можно разными способами, но если заставить людей платить и с души, и с двора, они разорятся.",103:"Пополнять казну, конечно, можно разными способами, но если заставить людей платить и с души, и с двора, они разорятся."}},failMessage:!1},103:{type:"economics",title:"Пропорциональный подоходный налог",content:"Обложить налогом представителей всех социальных групп без исключения пропорционально их доходам: чем больше доход, тем выше налог",relation:{conflict:"101|102"},messages:{conflict:{102:"Пополнять казну, конечно, можно разными способами, но если заставить людей платить и с души, и с двора, они разорятся.",101:"Налог может быть одинаковым для всех, а может зависеть от дохода, но он не может быть и таким, и другим одновременно; можно обязать платить всех, можно выключить из налогообложения отдельные категории населения, но сделать и то и другое одновременно опять же никак нельзя."}},failMessage:{title:"Конфуз вышел, государь!",content:"Все известные попытки введения пропорционального подоходного налога в условиях сословного общества закончились плачевно. В России они, по счастью, вообще не предпринимались вплоть до Первой мировой войны. Что же касается времен Петра I, служилое сословие по традиции рассматривалось как выплачивающее «налог кровью». Церковь, с некоторыми нюансами, была свободна от налогов еще с татаро-монгольских времен. Возложить дополнительное налоговое бремя на богатых купцов означало удушить оживляющуюся внешнюю торговлю и формирующуюся национальную промышленность. Иными словами, введение подоходного налога – слишком решительный шаг в условиях первой четверти XVIII века, который мог закончиться, чем угодно: бунтом, дворянским заговором, но только не победой в Северной войне."}}},messages:{conflict:[{id:"101102103",content:"Пополнять казну, конечно, можно разными способами, но налоговая система должна базироваться на какой-то одной подати."}],cardactivated:[{id:"1",cardId:"303",comment:"Заработала В3",content:"Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть."}],finalWin:[{id:"1",comment:"Вводное слово",title:"Виктория, государь!",content:"Швед разбит, Россия прочно закрепилась на Балтике, прорублено окно в Европу. Наше вымуштрованное войско, вооруженное по последнему слову военной техники и снабженное всем необходимым, отныне является одним из сильнейших в Европе и мире."}],finalFail:[{id:"1",comment:"Вводное слово",title:"Конфуз вышел, государь!",content:"Как разбить шведа, когда "}]}},Reforma=function(){var e=this,a=data.deck,o=0,s=2,r=[],n=[],t="";e.init=function(){e.reset(),g()},e.reset=function(){console.log("reset",1),o=0,s=2,r=[],n=[],t="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var e=$(".reforma-game_info-message"),a=$(".reforma-game_info-action");e.addClass("is-hide"),a.removeClass("is-hide"),$(".reforma_card").remove(),i(),shuffle(r),c(),l()};var i=function(){var e=$(".reforma-deck_card");for(var o in a){var s="",n=a[o];"economics"==n.type?s+="Экономика":"social"==n.type?s+="Социальная сфера":"war"==n.type&&(s+="Военное дело");var t=$('  <div class="reforma_card '+n.type+'" id="'+o+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+s+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+n.title+'</div>\t\t<div class="reforma_card-text">'+n.content+"</div>  \t </div>  </div>");r.push(o),e.prepend(t)}},c=function(){t=$("#"+r[0]),t.addClass("is-active").siblings(".reforma_card").removeClass("is-active")},l=function(){console.log("setPoints",o);var e=$(".reforma-game_score");e.text(o),o>=100&&C("total-victory")},d=function(e){var a=$(".reforma-game_life");s-=1,console.log("qwe",s),1==s&&(a.eq(1).addClass("is-burn"),M(e)),0==s&&(a.eq(0).addClass("is-burn"),C("total-defeat"))},f=function(e){t.removeClass("is-active"),r.splice(0,1),a[e].failMessage&&d(e),console.log("putOnTable",e);var o=$(".reforma-game_col.is-economy").find(".reforma-game_content"),s=$(".reforma-game_col.is-social").find(".reforma-game_content"),i=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+e).hasClass("economics")?o.prepend($("#"+e)):$("#"+e).hasClass("social")?s.prepend($("#"+e)):$("#"+e).hasClass("war")&&i.prepend($("#"+e)),$("#"+e).addClass("on-desk"),n.push(e),0==r.length&&_()},p=function(e){if(0==n.length)console.log("first or last?",e),f(e);else{var s=a[e].relation,r=a[e].messages,t=!1;if(void 0!=s)for(key in s){var i=u(s[key]),c=m(s[key]),d=r[key],p=[];if(i){for(j in d)v(c).forEach(function(e){e==j?p.push(e):console.log("wtf")});switch(console.log("ids",c),console.log("message",p),key){case"needs":x(e,v(c),p),$("#"+e).addClass("is-act"),o+=v(c).length,l(),t=!0;break;case"conflict":b(e,v(c),p),t=!0;break;case"option":o+=1,l()}}}t||f(e)}},m=function(e){var a=[],o=/(x|\&|\|)/g;return e.replace(o,",$1").split(/,/g).forEach(function(e){e.length&&(e[0].match(o)?id=e.substr(1):id=e,a.push(id))}),a},u=function(e){if(0==!e.length){var a=!1,o=/(x|\&|\|)/g;return e.replace(o,",$1").split(/,/g).forEach(function(s){console.log(e);var r,n="|";if(s.length){if(s[0].match(o)?(n=s[0],r=s.substr(1)):r=s,"x"==n){var t=h(r);a=a?!t:t}"&"==n&&(a&=h(r)),"|"==n&&(a|=h(r))}}),console.log("result-main",a),a}return!1},v=function(e){return e.filter(function(e){return h(e)})},h=function(e){var a=n.filter(function(a){return a==e});return a.length>0},g=function(){var e=$(".reforma_card");e.on("click",function(){var e=$(this).attr("id");if(console.log("infoPopupData",e),$(this).hasClass("is-act")){var o=m(a[e].relation.needs),s=v(o),r=!0;w(e,s,r),console.log("infoPopupData",e,s,r)}else w(e)});var o=$(".js-act-add"),s=$(".js-act-skip"),n=$(".js-act-remove");o.on("click",function(){var e=t.attr("id");p(e),c()}),s.on("click",function(){r.push(r.splice(0,1)[0]),c()}),n.on("click",function(){r.splice(0,1),c(),0==r.length&&(t.removeClass("is-active"),_())})},_=function(){o>=2&&C("total-victory"),o<1&&C("total-loose")},C=function(e){var a=($(".reforma-game_info-message"),$(".reforma-game_info-action"));$("."+e).removeClass("is-hide"),a.addClass("is-hide"),$(".js-total-score").text(o),$(".js-popup-info-link").on("click",function(){E(e)})},k=function(e){var a=$(".js-overlay"),o=$(".js-popup"),s=$(".js-popup-close");$(".js-popup_content-card");o.addClass("is-hide"),a.removeClass("is-hide"),$("."+e).removeClass("is-hide"),s.on("click",function(){y(e)}),$(document).on("keydown",function(a){27==a.which&&y(e)})},y=function(e){var a=$(".js-overlay"),o=$("."+e)||$(".js-popup"),s=$(".js-popup_content-card"),r=$(".reforma-popup_card-wrap");a.addClass("is-hide"),o.addClass("is-hide"),s.empty(),r.empty()},w=function(e,o,s){var r=$(".card-info").find(".js-popup_content-card"),n=$(".card-info.js-popup"),t=$(".card-info").find(".reforma-popup_card-wrap");k("card-info",s),o=o||[],$("#"+e).clone().removeClass("on-desk").attr("id","").prependTo(r),o.forEach(function(e){$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(t)}),console.log("actPopup",s),s?n.addClass("card-active"):n.removeClass("card-active"),t.find(".reforma_card").on("click",function(){r.empty();var e=$(this).attr("id");if($(this).hasClass("is-act")){var o=m(a[e].relation.needs),s=v(o),n=!0;w(e,s,n)}else w(e)})},b=function(e,o,s){var r=$(".conflict").find(".js-popup_content-card"),t=$(".conflict").find(".js-popup-text");k("conflict"),o=o||[],t.text(a[e].messages.conflict[s]),$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(r),o.forEach(function(e){$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(r)}),$(".conflict").find(".reforma_card").on("click",function(){var e=$(this).attr("id"),a=$(this).siblings(".reforma_card").attr("id"),o=n.indexOf(a);o>-1&&n.splice(o,1),$("#"+a).remove(),y("conflict"),p(e),c()})},x=function(e,o,s){var r=$(".started-work").find(".js-popup_content-card"),n='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[e].title+'</div>\t  <div class="reforma-popup_par">'+a[e].content+"</div></div>";k("started-work"),o=o||[],r.prepend(n),o.forEach(function(e){var o='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[e].title+'</div>\t  <div class="reforma-popup_par">'+a[e].messages.needs[s]+"</div></div>";r.prepend(o)}),f(e)},M=function(e){var o=$(".lost-life").find(".js-popup_content-card"),s='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+a[e].failMessage.content+"</div></div>";k("lost-life"),o.prepend(s)},E=function(e){var a,o=$(".finish.js-popup"),s=$(".finish .reforma-popup_title");k("finish"),a="total-loose"==e?"Вы проиграли":"total-defeat"==e?"У вас бунт, государь":"Виктория, государь!",o.addClass(e),s.text(a)}};$(document).ready(function(){var e=$(".js-reforma-start"),a=new Reforma;a.init(),e.on("click",function(e){e.preventDefault(),a.reset()})});