function ajax(){return $.getJSON("data.json")}function shuffle(a){for(var s,e,n=a.length;0!==n;)e=Math.floor(Math.random()*n),n-=1,s=a[n],a[n]=a[e],a[e]=s;return a}var data=null;ajax().done(function(a){data=a;var s=$(".js-reforma-start"),e=new Reforma;e.init(),s.on("click",function(a){a.preventDefault(),e.reset()})});var Reforma=function(){var a=this,s=data.deck,e=0,n=2,d=[],i=[],r="";a.init=function(){a.reset(),M()},a.reset=function(){console.log("reset",1),e=0,n=2,d=[],i=[],r="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var a=$(".reforma-game_info-message"),s=$(".reforma-game_info-action");a.addClass("is-hide"),s.removeClass("is-hide"),$(".reforma_card").remove(),$(".reforma-deck_card").removeClass("is-end is-ending"),c(),shuffle(d),o(),f()};var c=function(){var a=$(".reforma-deck_card");for(var e in s){var n="",i=s[e];"economics"==i.type?n+="Экономика":"social"==i.type?n+="Социальная сфера":"war"==i.type&&(n+="Военное дело");var r=$('  <div class="reforma_card '+i.type+'" id="'+e+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+n+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+i.title+'</div>\t\t<div class="reforma_card-text">'+i.content+"</div>  \t </div>  </div>");d.push(e),a.prepend(r)}var c=$(".reforma_card");c.on("click",t)},t=function(){if(console.log($(this)),$(this).hasClass("on-desk")||$(this).closest(".reforma-popup_card-content")){var a=$(this).attr("id");if($(this).hasClass("is-act")&&void 0==s[a].relation.needs){var e=!0;k(a,e)}else if($(this).hasClass("is-act")&&void 0!=s[a].relation.needs){var e=!0,n=p(s[a].relation.needs),d=u(n);k(a,e,d)}else k(a)}},o=function(){r=$("#"+d[0]),r.addClass("is-active").siblings(".reforma_card").removeClass("is-active zoomOutLeft zoomOutRight")},f=function(){var a=$(".reforma-game_score");a.text(e),e>=10&&C("total-victory")},l=function(a){var s=$(".reforma-game_life");if(n-=1,d.splice(0,1),o(),1==n&&(s.eq(1).addClass("is-burn"),W(a)),0==n){var e=!0;s.eq(0).addClass("is-burn"),W(a,e),C("total-defeat")}},g=function(a){if(r.removeClass("is-active"),d.splice(0,1),x(a)||i.push(a),i.length>0)for(var e=0;e<i.length-1;e++)m(i[e],!0);void 0==s[a].relation||void 0!=s[a].relation.needs||$("#"+a).hasClass("is-act")||$("#"+a).addClass("is-act"),console.log("putOnTable",a);var n=$(".reforma-game_col.is-economy").find(".reforma-game_content"),c=$(".reforma-game_col.is-social").find(".reforma-game_content"),t=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+a).hasClass("economics")?n.prepend($("#"+a)):$("#"+a).hasClass("social")?c.prepend($("#"+a)):$("#"+a).hasClass("war")&&t.prepend($("#"+a)),$("#"+a).addClass("on-desk"),0==d.length&&h()},m=function(a,n){if(0==i.length)g(a);else{var d=s[a].relation,r=s[a].messages,c=!1;if(void 0!=d)for(key in d)if(!n||"needs"==key){var t=v(d[key]),o=p(d[key]),m=r[key],M=[];if(t){for(j in m)u(o).forEach(function(a){a==j&&M.push(a)});switch(key){case"needs":console.log("card needs",a,s[a].relation.needs,$("#"+a).hasClass("is-act")),$("#"+a).hasClass("is-act")?o.filter(function(s){return s==a}).length>0&&(e++,f()):(y(a,u(o),M),$("#"+a).addClass("is-act"),e+=u(o).length,f());break;case"conflict":console.log("card conflict",a,s[a].relation.conflict),F(a,u(o),M),c=!0;break;case"option":e+=1,f()}}}c||x(a)||s[a].failMessage||g(a),s[a].failMessage&&l(a)}},p=function(a){var s=[],e=/(x|\&|\|)/g;return a.replace(e,",$1").split(/,/g).forEach(function(a){a.length&&(a[0].match(e)?id=a.substr(1):id=a,s.push(id))}),s},v=function(a){if(0==!a.length){var s=!1,e=/(x|\&|\|)/g;return a.replace(e,",$1").split(/,/g).forEach(function(a){var n,d="|";if(a.length){if(a[0].match(e)?(d=a[0],n=a.substr(1)):n=a,"x"==d){var i=x(n);s=s?!i:i}"&"==d&&(s&=x(n)),"|"==d&&(s|=x(n))}}),s}return!1},u=function(a){return a.filter(function(a){return x(a)})},x=function(a){var s=i.filter(function(s){return s==a});return s.length>0},M=function(){var a=$(".js-act-add"),s=$(".js-act-skip"),e=$(".js-act-remove");a.on("click",function(){O();var a=r.attr("id");m(a),o()}),s.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutLeft"),setTimeout(function(){d.push(d.splice(0,1)[0]),o(),O()},1e3)}),e.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutRight"),setTimeout(function(){d.splice(0,1),o(),O()},700)})},O=function(){var a=$(".reforma-deck_card");2==d.length?a.addClass("is-ending"):1==d.length?a.addClass("is-end").removeClass("is-ending"):0==d.length&&(r.removeClass("is-active"),h())},h=function(){e>=2&&C("total-victory"),e<1&&C("total-loose")},C=function(a){var s=($(".reforma-game_info-message"),$(".reforma-game_info-action"));$("."+a).removeClass("is-hide"),s.addClass("is-hide"),$(".js-total-score").text(e),$(".js-popup-info-link").on("click",function(){w(a)})},_=function(a){var s=$(".js-overlay"),e=$(".js-popup"),n=$(".js-popup-close");$(".js-popup_content-card");e.addClass("is-hide"),s.removeClass("is-hide"),$("."+a).removeClass("is-hide"),n.on("click",function(){I(a)}),$(document).on("keydown",function(s){27==s.which&&I(a)})},I=function(a){var s=$(".js-overlay"),e=$("."+a)||$(".js-popup"),n=$(".js-popup_content-card"),d=$(".reforma-popup_card-wrap");s.addClass("is-hide"),e.addClass("is-hide"),n.empty(),d.empty()},k=function(a,s,e){var n=$(".card-info").find(".js-popup_content-card"),d=$(".card-info.js-popup"),i=$(".card-info").find(".reforma-popup_card-wrap");n.empty(),_("card-info",s),e=e||[],$("#"+a).clone().removeClass("on-desk").attr("id","").prependTo(n),e.forEach(function(a){$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i)}),s?d.addClass("card-active"):d.removeClass("card-active"),e.length>0?d.addClass("card-active-cards"):d.removeClass("card-active-cards"),i.find(".reforma_card").on("click",t)},F=function(a,e,n){var d=$(".conflict").find(".js-popup_content-card"),r=$(".conflict").find(".js-popup-text");_("conflict"),n.forEach(function(e){var n=s[a].messages.conflict[e];r.text(data.content[n])}),$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(d),e[0]&&$("#"+e[0]).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(d),$(".conflict").find(".reforma_card").on("click",function(){var a=$(this).attr("id"),s=$(this).siblings(".reforma_card").attr("id"),e=i.indexOf(s);e>-1&&i.splice(e,1),$("#"+s).remove(),I("conflict"),g(a),o()})},y=function(a,e,n){var d;n.forEach(function(e){var n=s[a].messages.needs[e];d=data.content[n]});var i=$(".started-work").find(".js-popup_content-card"),r='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+s[a].title+'</div>\t  <div class="reforma-popup_par">'+d+"</div></div>";_("started-work"),i.prepend(r),e=e||[],e.forEach(function(a){'<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+s[a].title+'</div>\t  <div class="reforma-popup_par">'+d+"</div></div>"})},W=function(a,e){var n=$(".lost-life").find(".js-popup_content-card"),d='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+s[a].failMessage.content+"</div></div>";_("lost-life"),n.prepend(d),e?n.next(".reforma-popup_par.is-info").addClass("is-hide"):n.next(".reforma-popup_par.is-info").removeClass("is-hide")},w=function(a){function s(a,s){console.log(s),s='<div class="reforma-popup_par">'+a+"</div>",console.log("simple"),r.append(s)}var e,n=$(".finish.js-popup"),d=$(".finish .reforma-popup_title"),r=n.find(".reforma-popup_wrap");_("finish"),e="total-loose"==a?"Вы проиграли":"total-defeat"==a?"У вас бунт, государь":"Виктория, государь!",n.addClass(a),d.text(e),"total-victory"==a?i.indexOf("303")>0&&i.indexOf("312")>0&&i.indexOf("310")>0&&i.indexOf("311")>0?(cardsMessage=data.messages.finalWin[0].content,s(cardsMessage,"cardInfo")):(cardsMessage=data.messages.finalWin[1].content,s(cardsMessage,"cardInfoExtra"),i.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[2].content,s(cardsMessage,"cardInfo")),i.indexOf("108")>0&&i.indexOf("210")<0&&(cardsMessage=data.messages.finalWin[3].content,s(cardsMessage,"cardInfo")),(i.indexOf("106")<0||i.indexOf("109")>0)&&(cardsMessage=data.messages.finalWin[4].content,s(cardsMessage,"cardInfo")),i.indexOf("111")>0&&i.indexOf("210")<0&&i.indexOf("211")<0&&(cardsMessage=data.messages.finalWin[5].content,s(cardsMessage,"cardInfo")),i.indexOf("311")>0&&i.indexOf("310")<0&&(cardsMessage=data.messages.finalWin[6].content,s(cardsMessage,"cardInfo")),i.indexOf("311")>0&&i.indexOf("310")>0&&(cardsMessage=data.messages.finalWin[7].content,s(cardsMessage,"cardInfo")),i.indexOf("211")>0&&(cardsMessage=data.messages.finalWin[8].content,s(cardsMessage,"cardInfo")),i.indexOf("209")>0&&(cardsMessage=data.messages.finalWin[9].content,s(cardsMessage,"cardInfo")),(i.indexOf("110")<0||i.indexOf("111")<0)&&(cardsMessage=data.messages.finalWin[10].content,s(cardsMessage,"cardInfo")),i.indexOf("110")<0&&i.indexOf("111")>0&&(cardsMessage=data.messages.finalWin[11].content,s(cardsMessage,"cardInfo")),i.indexOf("111")<0&&i.indexOf("110")>0&&(cardsMessage=data.messages.finalWin[12].content,s(cardsMessage,"cardInfo")),i.indexOf("304")>0&&(cardsMessage=data.messages.finalWin[13].content,s(cardsMessage,"cardInfo")),i.indexOf("302")<0&&(cardsMessage=data.messages.finalWin[14].content,s(cardsMessage,"cardInfo")),i.indexOf("208")<0&&(cardsMessage=data.messages.finalWin[15].content,s(cardsMessage,"cardInfo")),i.indexOf("104")>0&&i.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[16].content,s(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalWin[17].content,s(cardsMessage,"cardInfoExtra")):"total-loose"==a&&(cardsMessage=data.messages.finalFail[0].content,s(cardsMessage,"cardInfo"),i.indexOf("303")<0?(cardsMessage=data.messages.finalFail[1].content,s(cardsMessage,"cardInfo")):i.indexOf("312")<0?(cardsMessage=data.messages.finalFail[3].content,s(cardsMessage,"cardInfo")):i.indexOf("310")<0&&i.indexOf("311")<0&&(cardsMessage=data.messages.finalFail[2].content,s(cardsMessage,"cardInfo")),i.indexOf("303")>0&&!$("#303").hasClass("is-act")&&(i.indexOf("306")>0&&(cardsMessage=data.messages.finalFail[4].content,s(cardsMessage,"cardInfo")),i.indexOf("307")<0&&i.indexOf("306")<0&&(cardsMessage=data.messages.finalFail[5].content,s(cardsMessage,"cardInfo"))),i.indexOf("312")>0&&!$("#312").hasClass("is-act")&&i.indexOf("101")<0&&(cardsMessage=data.messages.finalFail[6].content,s(cardsMessage,"cardInfo"),i.indexOf("101")<0&&i.indexOf("102")<0&&(cardsMessage=data.messages.finalFail[7].content,s(cardsMessage,"cardInfo")),i.indexOf("101")<0&&i.indexOf("102")>0&&(cardsMessage=data.messages.finalFail[8].content,s(cardsMessage,"cardInfo"))),i.indexOf("202")>0&&!$("#202").hasClass("is-act")&&(i.indexOf("107")<0&&i.indexOf("106")<0&&i.indexOf("311")<0&&(cardsMessage=data.messages.finalFail[9].content,s(cardsMessage,"cardInfo")),($("#106").hasClass("is-act")?!$("#107").hasClass("is-act"):$("#107").hasClass("is-act"))&&i.indexOf("202")<0&&(cardsMessage=data.messages.finalFail[10].content,s(cardsMessage,"cardInfo")),$("#106").hasClass("is-act")&&i.indexOf("107")<0&&(cardsMessage=data.messages.finalFail[11].content,s(cardsMessage,"cardInfo")),i.indexOf("106")>0&&i.indexOf("210")<0&&(cardsMessage=data.messages.finalFail[12].content,s(cardsMessage,"cardInfo")),i.indexOf("107")>0&&i.indexOf("106")<0&&i.indexOf("101")<0&&i.indexOf("110")<0&&(i.indexOf("111")<0||!$("#107").hasClass("is-act"))&&(cardsMessage=data.messages.finalFail[13].content,s(cardsMessage,"cardInfo"),i.indexOf("102")>0&&i.indexOf("312")<0&&(cardsMessage=data.messages.finalFail[14].content,s(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[15].content,s(cardsMessage,"cardInfo")),i.indexOf("111")>0&&i.indexOf("101")<0&&i.indexOf("110")<0&&(cardsMessage=data.messages.finalFail[16].content,s(cardsMessage,"cardInfo"))),i.indexOf("311")>0&&!$("#311").hasClass("is-act")&&i.indexOf("310")<0&&i.indexOf("105")<0&&(cardsMessage=data.messages.finalFail[17].content,s(cardsMessage,"cardInfo")),i.indexOf("310")>0&&!$("#310").hasClass("is-act")&&$("#202").hasClass("is-act")&&i.indexOf("311")<0&&i.indexOf("112")<0&&(cardsMessage=data.messages.finalFail[18].content,s(cardsMessage,"cardInfo")),i.indexOf("313")>0&&(cardsMessage=data.messages.finalFail[19].content,s(cardsMessage,"cardInfo")),i.indexOf("303")>0&&i.indexOf("307")>0&&i.indexOf("304")<0&&i.indexOf("314")<0&&(cardsMessage=data.messages.finalFail[20].content,s(cardsMessage,"cardInfo")),i.indexOf("303")>0&&i.indexOf("307")>0&&i.indexOf("301")<0&&(cardsMessage=data.messages.finalFail[21].content,s(cardsMessage,"cardInfo")),i.indexOf("314")>0&&!$("#314").hasClass("is-act")&&(cardsMessage=data.messages.finalFail[22].content,s(cardsMessage,"cardInfo"),i.indexOf("305")<0&&i.indexOf("304")<0&&(cardsMessage=data.messages.finalFail[23].content,s(cardsMessage,"cardInfo")),i.indexOf("302")<0&&(cardsMessage=data.messages.finalFail[24].content,s(cardsMessage,"cardInfo"),i.indexOf("302")<0&&i.indexOf("304")>0&&(cardsMessage=data.messages.finalFail[25].content,s(cardsMessage,"cardInfo")),i.indexOf("302")<0&&i.indexOf("305")>0&&(cardsMessage=data.messages.finalFail[26].content,s(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[27].content,s(cardsMessage,"cardInfo")),i.indexOf("204")<0&&(cardsMessage=data.messages.finalFail[28].content,s(cardsMessage,"cardInfo")),i.indexOf("206")<0&&(cardsMessage=data.messages.finalFail[29].content,s(cardsMessage,"cardInfo"))))}};