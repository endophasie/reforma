function ajax(){return $.getJSON("data.json")}function shuffle(e){for(var a,s,r=e.length;0!==r;)s=Math.floor(Math.random()*r),r-=1,a=e[r],e[r]=e[s],e[s]=a;return e}var data=null;ajax().done(function(e){data=e;var a=$(".js-reforma-start"),s=new Reforma;s.init(),a.on("click",function(e){e.preventDefault(),s.reset()})});var Reforma=function(){var e=this,a=data.deck,s=0,r=2,o=[],i=[],n="";e.init=function(){e.reset(),_()},e.reset=function(){console.log("reset",1),s=0,r=2,o=[],i=[],n="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var e=$(".reforma-game_info-message"),a=$(".reforma-game_info-action");e.addClass("is-hide"),a.removeClass("is-hide"),$(".reforma_card").remove(),$(".reforma-deck_card").removeClass("is-end is-ending"),t(),shuffle(o),c(),d()};var t=function(){var e=$(".reforma-deck_card");for(var s in a){var r="",i=a[s];"economics"==i.type?r+="Экономика":"social"==i.type?r+="Социальная сфера":"war"==i.type&&(r+="Военное дело");var n=$('  <div class="reforma_card '+i.type+'" id="'+s+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+r+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+i.title+'</div>\t\t<div class="reforma_card-text">'+i.content+"</div>  \t </div>  </div>");o.push(s),e.prepend(n)}},c=function(){n=$("#"+o[0]),n.addClass("is-active").siblings(".reforma_card").removeClass("is-active zoomOutLeft zoomOutRight")},d=function(){var e=$(".reforma-game_score");e.text(s),s>=100&&k("total-victory")},f=function(e){var a=$(".reforma-game_life");if(r-=1,o.splice(0,1),c(),1==r&&(a.eq(1).addClass("is-burn"),O(e)),0==r){var s=!0;a.eq(0).addClass("is-burn"),O(e,s),k("total-defeat")}},l=function(e){if(n.removeClass("is-active"),o.splice(0,1),h(e)||i.push(e),i.length>0)for(var a=0;a<i.length-1;a++)p(i[a],!0);console.log("putOnTable",e);var s=$(".reforma-game_col.is-economy").find(".reforma-game_content"),r=$(".reforma-game_col.is-social").find(".reforma-game_content"),t=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+e).hasClass("economics")?s.prepend($("#"+e)):$("#"+e).hasClass("social")?r.prepend($("#"+e)):$("#"+e).hasClass("war")&&t.prepend($("#"+e)),$("#"+e).addClass("on-desk"),0==o.length&&C()},p=function(e,r){if(0==i.length)l(e);else{var o=a[e].relation,n=a[e].messages,t=!1;if(void 0!=o)for(key in o)if(!r||"needs"==key){var c=u(o[key]),p=m(o[key]),_=n[key],g=[];if(c){for(j in _)v(p).forEach(function(e){e==j&&g.push(e)});switch(key){case"needs":console.log("card needs",e,a[e].relation.needs,$("#"+e).hasClass("is-act")),$("#"+e).hasClass("is-act")?p.filter(function(a){return a==e}).length>0&&(s++,d()):(E(e,v(p),g),$("#"+e).addClass("is-act"),s+=v(p).length,d());break;case"conflict":console.log("card conflict",e,a[e].relation.conflict),b(e,v(p),g),t=!0;break;case"option":s+=1,d()}}}t||h(e)||a[e].failMessage||l(e),a[e].failMessage&&f(e)}},m=function(e){var a=[],s=/(x|\&|\|)/g;return e.replace(s,",$1").split(/,/g).forEach(function(e){e.length&&(e[0].match(s)?id=e.substr(1):id=e,a.push(id))}),a},u=function(e){if(0==!e.length){var a=!1,s=/(x|\&|\|)/g;return console.log("1",e,i),e.replace(s,",$1").split(/,/g).forEach(function(r){console.log("2",e);var o,i="|";if(r.length){if(r[0].match(s)?(i=r[0],o=r.substr(1)):o=r,"x"==i){var n=h(o);a=a?!n:n}"&"==i&&(a&=h(o)),"|"==i&&(a|=h(o))}}),a}return!1},v=function(e){return e.filter(function(e){return h(e)})},h=function(e){var a=i.filter(function(a){return a==e});return a.length>0},_=function(){var e=$(".reforma_card");e.on("click",function(){if(console.log("playCards",$(this)),$(this).hasClass("on-desk")){var e=$(this).attr("id");if($(this).hasClass("is-act")){var s=m(a[e].relation.needs),r=v(s),o=!0;w(e,r,o)}else w(e)}});var s=$(".js-act-add"),r=$(".js-act-skip"),i=$(".js-act-remove");s.on("click",function(){g();var e=n.attr("id");p(e),c()}),r.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutLeft"),setTimeout(function(){o.push(o.splice(0,1)[0]),c(),g()},1e3)}),i.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutRight"),setTimeout(function(){o.splice(0,1),c(),g()},700)})},g=function(){var e=$(".reforma-deck_card");7==o.length?e.addClass("is-ending"):1==o.length?e.addClass("is-end").removeClass("is-ending"):0==o.length&&(n.removeClass("is-active"),C())},C=function(){s>=2&&k("total-victory"),s<1&&k("total-loose")},k=function(e){var a=($(".reforma-game_info-message"),$(".reforma-game_info-action"));$("."+e).removeClass("is-hide"),a.addClass("is-hide"),$(".js-total-score").text(s),$(".js-popup-info-link").on("click",function(){T(e)})},y=function(e){var a=$(".js-overlay"),s=$(".js-popup"),r=$(".js-popup-close");$(".js-popup_content-card");s.addClass("is-hide"),a.removeClass("is-hide"),$("."+e).removeClass("is-hide"),r.on("click",function(){x(e)}),$(document).on("keydown",function(a){27==a.which&&x(e)})},x=function(e){var a=$(".js-overlay"),s=$("."+e)||$(".js-popup"),r=$(".js-popup_content-card"),o=$(".reforma-popup_card-wrap");a.addClass("is-hide"),s.addClass("is-hide"),r.empty(),o.empty()},w=function(e,s,r){var o=$(".card-info").find(".js-popup_content-card"),i=$(".card-info.js-popup"),n=$(".card-info").find(".reforma-popup_card-wrap");y("card-info",r),s=s||[],$("#"+e).clone().removeClass("on-desk").attr("id","").prependTo(o),s.forEach(function(e){$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(n)}),r?i.addClass("card-active"):i.removeClass("card-active"),n.find(".reforma_card").on("click",function(){o.empty();var e=$(this).attr("id");if($(this).hasClass("is-act")){var s=m(a[e].relation.needs),r=v(s),i=!0;w(e,r,i)}else w(e)})},b=function(e,s,r){var o=$(".conflict").find(".js-popup_content-card"),n=$(".conflict").find(".js-popup-text");y("conflict"),r.forEach(function(s){var r=a[e].messages.conflict[s];n.text(data.content[r])}),$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(o),s[0]&&$("#"+s[0]).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(o),$(".conflict").find(".reforma_card").on("click",function(){var e=$(this).attr("id"),a=$(this).siblings(".reforma_card").attr("id"),s=i.indexOf(a);s>-1&&i.splice(s,1),$("#"+a).remove(),x("conflict"),l(e),c()})},E=function(e,s,r){var o;r.forEach(function(s){var r=a[e].messages.needs[s];o=data.content[r]});var i=$(".started-work").find(".js-popup_content-card"),n='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[e].title+'</div>\t  <div class="reforma-popup_par">'+o+"</div></div>";y("started-work"),i.prepend(n),s=s||[],s.forEach(function(e){'<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[e].title+'</div>\t  <div class="reforma-popup_par">'+o+"</div></div>"})},O=function(e,s){var r=$(".lost-life").find(".js-popup_content-card"),o='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+a[e].failMessage.content+"</div></div>";y("lost-life"),r.prepend(o),s?r.next(".reforma-popup_par.is-info").addClass("is-hide"):r.next(".reforma-popup_par.is-info").removeClass("is-hide")},T=function(e){var a,s=$(".finish.js-popup"),r=$(".finish .reforma-popup_title");y("finish"),a="total-loose"==e?"Вы проиграли":"total-defeat"==e?"У вас бунт, государь":"Виктория, государь!",s.addClass(e),r.text(a)}};