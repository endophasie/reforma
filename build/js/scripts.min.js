function ajax(){return $.getJSON("data.json")}function shuffle(a){for(var e,s,n=a.length;0!==n;)s=Math.floor(Math.random()*n),n-=1,e=a[n],a[n]=a[s],a[s]=e;return a}var data=null;ajax().done(function(a){data=a;var e=$(".js-reforma-start"),s=new Reforma;s.init(),e.on("click",function(a){a.preventDefault(),s.reset()})});var Reforma=function(){var a=this,e=data.deck,s=0,n=2,i=[],t=[],r="",d="",o={active:[],disactive:[],removed:"",clear:function(){this.active.length=0,this.disactive.length=0,this.removed=""}};a.init=function(){a.reset(),k()},a.reset=function(){m("reset",1),s=0,n=2,i=[],t=[],r="",d="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var a=$(".reforma-game_info-message"),e=$(".reforma-game_info-action");a.addClass("is-hide"),e.removeClass("is-hide"),$(".reforma_card").remove(),$(".reforma-deck_card").removeClass("is-end is-ending is-hide"),c(),shuffle(i),l(),g()};var c=function(){var a=$(".reforma-deck_card");for(var s in e){var n="",t=e[s];"economics"==t.type?n+="Экономика":"social"==t.type?n+="Социальная сфера":"war"==t.type&&(n+="Военное дело");var r=$('  <div class="reforma_card '+t.type+'" id="'+s+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+n+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+t.title+'</div>\t\t<div class="reforma_card-text">'+t.content+"</div>  \t </div>  </div>");i.push(s),a.prepend(r)}var d=$(".reforma_card");d.on("click",f)},f=function(){if($(this).hasClass("on-desk")||$(this).closest(".reforma-popup_card-content")){var a=$(this).attr("id");if(!$(this).hasClass("is-act")||void 0!=e[a].relation&&void 0!=e[a].relation.needs)if($(this).hasClass("is-act")&&void 0!=e[a].relation.needs){var s=!0,n=h(e[a].relation.needs),i=O(n,!0);E(a,s,i)}else E(a);else{var s=!0;E(a,s)}}},l=function(){r=$("#"+i[0]),r.addClass("is-active").siblings(".reforma_card").removeClass("is-active")},g=function(){var a=$(".reforma-game_score");a.text(s)},p=function(a){var e=$(".reforma-game_life");if(n-=1,u(),l(),1==n&&(e.eq(1).addClass("is-burn"),R(a)),0==n){var s=!0;e.eq(0).addClass("is-burn"),R(a,s),W("total-defeat")}},m=function(a,e){var s=[];s.filter(function(e){return e==a}).length>0&&console.log(a+": ",e)},v=function(a){if(r.removeClass("is-active"),e[a].failMessage)return p(a),!1;m("putOnTable",a),_(a)||t.push(a),void 0!=e[a].relation&&void 0!=e[a].relation.needs||$("#"+a).hasClass("is-act")||$("#"+a).addClass("is-act");var s=$(".reforma-game_col.is-economy").find(".reforma-game_content"),n=$(".reforma-game_col.is-social").find(".reforma-game_content"),i=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+a).hasClass("economics")?s.prepend($("#"+a)):$("#"+a).hasClass("social")?n.prepend($("#"+a)):$("#"+a).hasClass("war")&&i.prepend($("#"+a)),$("#"+a).addClass("on-desk"),u()},u=function(){if(t.length>1){for(var a=!0;a;)for(var e=0;e<t.length-1&&!(a=x(t[e]));e++);s+=I(),g()}},x=function(a){if(0!=t.length){var n=e[a].relation,i=e[a].messages,r=!1,d=$("#"+a).hasClass("is-act"),c=!1;if(void 0!=n)for(key in n){var f=M(n[key],"conflict"!=key),l=h(n[key]),g=i[key],p=[];if(f){for(j in g)O(l).forEach(function(a){a==j&&p.push(a)});switch(key){case"needs":m("needs",a+e[a].relation.needs+d),d||(z(a,O(l,!0),p),$("#"+a).addClass("is-act"),m("needs",o.active+" "+s+$("#"+a)),o.active.push(a),c=!0);break;case"conflict":m("conflict",a,e[a].relation.conflict),T(a,O(l),p),r=!0;break;case"option":}}else d&&"needs"==key&&(m("needs",a),$("#"+a).removeClass("is-act"),o.disactive.push(a),c=!0)}return r||_(a)||v(a),c}v(a)},h=function(a){if(""==a)return[];var e=[],s=/(x|\&|\|)/g;return a.replace(s,",$1").split(/,/g).forEach(function(a){a.length&&(a[0].match(s)?id=a.substr(1):id=a,e.push(id))}),e},M=function(a,e){if(0==!a.length){var s=!1,n=/(x|\&|\|)/g;return a.replace(n,",$1").split(/,/g).forEach(function(a){var i,t="|";if(a.length)if(a[0].match(n)?(t=a[0],i=a.substr(1)):i=a,e){if("x"==t){var r=C(i);s=s?!r:r}"&"==t&&(s&=C(i)),"|"==t&&(s|=C(i))}else{if("x"==t){var r=_(i);s=s?!r:r}"&"==t&&(s&=_(i)),"|"==t&&(s|=_(i))}}),s}return!1},O=function(a,e){return e?(m("filter",a.filter(function(a){return m("filter",a+" is active = "+C(a)),C(a)})),a.filter(function(a){return C(a)})):a.filter(function(a){return _(a)})},_=function(a){var e=t.filter(function(e){return e==a});return e.length>0},C=function(a){var e=t.filter(function(e){return e==a&&$("#"+e).hasClass("is-act")});return e.length>0},I=function(){var a=0,s=O(t,!0);m("points","calculating points"),m("points",s),m("points",o.active);for(var n in o.active){var i=o.active[n],r=e[i];m("points","count points for "+r+" card, id = "+i),m("points_",r);var d=r.relation.needs+(r.relation.option?"|"+r.relation.option:"");m("points_",d),m("points",h(d)),a+=O(h(d),!0).length,m("points",a);for(var c in s)if(s.indexOf(i)>c){var f=e[s[c]],l=f.relation&&f.relation.needs?f.relation.needs:"",g=f.relation&&f.relation.option?f.relation.option:"";m("points_",l),h(l).indexOf(i)>=0&&(a++,m("points","needs link "+s[c])),h(g).indexOf(i)>=0&&(a++,m("points","option link "+a))}}var p=s.filter(function(a){return o.active.indexOf(a)<0});p=p.concat(o.disactive),console.log("earlyActivated",p,o.disactive),m("points_dis","result "+a);for(var n in o.disactive){var v=o.disactive[n],u=e[v];m("points_dis","decrement points for card = "+v),m("points_dis",u);var l=u.relation&&u.relation.needs?u.relation.needs:"",g=u.relation&&u.relation.option?u.relation.option:"",x=h(l),$=p.filter(function(a){return x.indexOf(a)>=0});m("points_dis",$),a-=$.length;var M=h(g);$=p.filter(function(a){return M.indexOf(a)>=0}),m("points_dis",$),a-=$.length,m("points_dis",a)}return o.clear(),m("points_dis","result "+a),a},k=function(){var a=$(".js-act-add"),e=$(".js-act-skip"),s=$(".js-act-remove"),n=$(".js-reforma-end");a.on("click",function(){i.splice(0,1),F();var a=r.attr("id");x(a),l()}),e.on("click",function(){var a=r.attr("id");$("#"+a).addClass("zoomOutLeft"),i.push(i.splice(0,1)[0]),l(),setTimeout(function(){$("#"+a).removeClass("zoomOutLeft")},1500)}),s.on("click",function(){var a=r.attr("id");$("#"+a).addClass("zoomOutRight"),i.splice(0,1),l(),F(),setTimeout(function(){$("#"+a).removeClass("zoomOutRight")},1e3)}),n.on("click",function(){W()})},F=function(){var a=$(".reforma-deck_card");2==i.length?a.addClass("is-ending"):1==i.length?a.addClass("is-end").removeClass("is-ending"):0==i.length&&(r.removeClass("is-active"),a.addClass("is-hide"))},y=function(){var a,e="310|311&303&312",s=h(e),n=O(s,!0);return a=M(e)&&n?"total-victory":"total-loose"},W=function(a){var e=($(".reforma-game_info-message"),$(".reforma-game_info-action"));if(void 0==a&&(a=y()),$("."+a).removeClass("is-hide"),e.addClass("is-hide"),1==s||21==s||31==s?$(".js-total-score").text(s+" очко"):s>=2&&s<=4||s>=22&&s<=24||s>=32&&s<=34?$(".js-total-score").text(s+" очка"):$(".js-total-score").text(s+" очков"),"total-loose"==a){var n=$(".total-loose .reforma-game_info-message-text").text();d=n,C(303)?!C(303)||C(310)&&C(311)?C(303)&&(C(310)||C(311))&&!C(312)?d=d+=data.messages.finalFail[3].content:C(303)||C(310)&&C(311)?C(303)&&(C(310)&&C(311)||C(312))||(d=d+=", "+data.messages.finalFail[3].content):d=d+=", "+data.messages.finalFail[2].content:d=d+=data.messages.finalFail[2].content:d=d+=data.messages.finalFail[1].content,d=d+="?",$(".total-loose .reforma-game_info-message-text").text(d)}$(".js-popup-info-link").on("click",function(){q(a)})},w=function(a){var e=$(".js-overlay"),s=$(".js-popup"),n=$(".js-popup-close");$(".js-popup_content-card");s.addClass("is-hide"),e.removeClass("is-hide"),$("."+a).removeClass("is-hide"),n.on("click",function(){b(a)}),$(document).on("keydown",function(e){27==e.which&&b(a)})},b=function(a){var e=$(".js-overlay"),s=$("."+a)||$(".js-popup"),n=$(".js-popup_content-card"),i=$(".reforma-popup_card-wrap");e.addClass("is-hide"),s.addClass("is-hide"),n.empty(),i.empty()},E=function(a,e,s){var n=$(".card-info").find(".js-popup_content-card"),i=$(".card-info.js-popup"),t=$(".card-info").find(".reforma-popup_card-wrap");n.empty(),t.empty(),w("card-info",e),s=s||[],$("#"+a).clone().removeClass("on-desk").attr("id","").prependTo(n),s.forEach(function(a){$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(t)}),e?i.addClass("card-active"):i.removeClass("card-active"),s.length>0?i.addClass("card-active-cards"):i.removeClass("card-active-cards"),t.find(".reforma_card").on("click",f)},T=function(a,s,n){var i=$(".conflict").find(".js-popup_content-card"),r=$(".conflict").find(".js-popup-text");w("conflict"),n.forEach(function(s){var n=e[a].messages.conflict[s];r.text(data.content[n])}),$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i),s[0]&&$("#"+s[0]).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i),$(".conflict").find(".reforma_card").on("click",function(){var a=$(this).attr("id"),e=$(this).siblings(".reforma_card").attr("id"),s=t.indexOf(e);s>-1&&(t.splice(s,1),o.removed=s),$("#"+e).remove(),o.disactive.push(e),b("conflict"),v(a),l()})},z=function(a,s,n){var i;n.forEach(function(s){var n=e[a].messages.needs[s];i=data.content[n]});var t=$(".started-work").find(".js-popup_content-card"),r='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+i+"</div></div>";w("started-work"),t.append(r),s=s||[],s.forEach(function(a){'<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+i+"</div></div>"})},R=function(a,s){var n=$(".lost-life").find(".js-popup_content-card"),i='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+e[a].failMessage.content+"</div></div>";w("lost-life"),n.prepend(i),s?n.next(".reforma-popup_par.is-info").addClass("is-hide"):n.next(".reforma-popup_par.is-info").removeClass("is-hide")},q=function(a){function e(a,e){if("cardInfo"==e)var s='<div class="reforma-popup_par">'+a+"</div>";else if("cardInfoExtra"==e)var s='<div class="reforma-popup_par-extra">'+a+"</div>";r.append(s)}var s,n=$(".finish.js-popup"),i=$(".finish .reforma-popup_title"),r=n.find(".js-popup_content-card");w("finish"),s="total-loose"==a?"Вы проиграли":"total-defeat"==a?"У вас бунт, государь":"Виктория, государь!",n.addClass(a),i.text(s),"total-victory"==a?(cardsMessage=data.messages.finalWin[1].content,e(cardsMessage,"cardInfoExtra"),t.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[2].content,e(cardsMessage,"cardInfo")),t.indexOf("108")>0&&t.indexOf("210")<0&&(cardsMessage=data.messages.finalWin[3].content,e(cardsMessage,"cardInfo")),(t.indexOf("106")<0||t.indexOf("109")>0)&&(cardsMessage=data.messages.finalWin[4].content,e(cardsMessage,"cardInfo")),t.indexOf("111")>0&&t.indexOf("210")<0&&t.indexOf("211")<0&&(cardsMessage=data.messages.finalWin[5].content,e(cardsMessage,"cardInfo")),t.indexOf("311")>0&&t.indexOf("310")<0&&(cardsMessage=data.messages.finalWin[6].content,e(cardsMessage,"cardInfo")),t.indexOf("311")>0&&t.indexOf("310")>0&&(cardsMessage=data.messages.finalWin[7].content,e(cardsMessage,"cardInfo")),t.indexOf("211")>0&&(cardsMessage=data.messages.finalWin[8].content,e(cardsMessage,"cardInfo")),t.indexOf("209")>0&&(cardsMessage=data.messages.finalWin[9].content,e(cardsMessage,"cardInfo")),(t.indexOf("110")<0||t.indexOf("111")<0)&&(cardsMessage=data.messages.finalWin[10].content,e(cardsMessage,"cardInfo")),t.indexOf("110")<0&&t.indexOf("111")>0&&(cardsMessage=data.messages.finalWin[11].content,e(cardsMessage,"cardInfo")),t.indexOf("111")<0&&t.indexOf("110")>0&&(cardsMessage=data.messages.finalWin[12].content,e(cardsMessage,"cardInfo")),t.indexOf("304")>0&&(cardsMessage=data.messages.finalWin[13].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&(cardsMessage=data.messages.finalWin[14].content,e(cardsMessage,"cardInfo")),t.indexOf("208")<0&&(cardsMessage=data.messages.finalWin[15].content,e(cardsMessage,"cardInfo")),t.indexOf("104")>0&&t.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[16].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalWin[17].content,e(cardsMessage,"cardInfoExtra")):"total-loose"==a&&(C(303)&&C(310)&&C(311)&&C(312)||(cardsMessage=d,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&!$("#303").hasClass("is-act")&&(t.indexOf("306")>0&&(cardsMessage=data.messages.finalFail[4].content,e(cardsMessage,"cardInfo")),t.indexOf("307")<0&&t.indexOf("306")<0&&(cardsMessage=data.messages.finalFail[5].content,e(cardsMessage,"cardInfo"))),t.indexOf("312")>0&&!$("#312").hasClass("is-act")&&t.indexOf("101")<0&&(cardsMessage=data.messages.finalFail[6].content,e(cardsMessage,"cardInfo"),t.indexOf("101")<0&&t.indexOf("102")<0&&(cardsMessage=data.messages.finalFail[7].content,e(cardsMessage,"cardInfo")),t.indexOf("101")<0&&t.indexOf("102")>0&&(cardsMessage=data.messages.finalFail[8].content,e(cardsMessage,"cardInfo"))),t.indexOf("202")>0&&!$("#202").hasClass("is-act")&&(t.indexOf("107")<0&&t.indexOf("106")<0&&t.indexOf("311")<0&&(cardsMessage=data.messages.finalFail[9].content,e(cardsMessage,"cardInfo")),($("#106").hasClass("is-act")?!$("#107").hasClass("is-act"):$("#107").hasClass("is-act"))&&t.indexOf("202")<0&&(cardsMessage=data.messages.finalFail[10].content,e(cardsMessage,"cardInfo")),$("#106").hasClass("is-act")&&t.indexOf("107")<0&&(cardsMessage=data.messages.finalFail[11].content,e(cardsMessage,"cardInfo")),t.indexOf("106")>0&&t.indexOf("210")<0&&(cardsMessage=data.messages.finalFail[12].content,e(cardsMessage,"cardInfo")),t.indexOf("107")>0&&t.indexOf("106")<0&&t.indexOf("101")<0&&t.indexOf("110")<0&&(t.indexOf("111")<0||!$("#107").hasClass("is-act"))&&(cardsMessage=data.messages.finalFail[13].content,e(cardsMessage,"cardInfo"),t.indexOf("102")>0&&t.indexOf("312")<0&&(cardsMessage=data.messages.finalFail[14].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[15].content,e(cardsMessage,"cardInfo")),t.indexOf("111")>0&&t.indexOf("101")<0&&t.indexOf("110")<0&&(cardsMessage=data.messages.finalFail[16].content,e(cardsMessage,"cardInfo"))),t.indexOf("311")>0&&!$("#311").hasClass("is-act")&&t.indexOf("310")<0&&t.indexOf("105")<0&&(cardsMessage=data.messages.finalFail[17].content,e(cardsMessage,"cardInfo")),t.indexOf("310")>0&&!$("#310").hasClass("is-act")&&$("#202").hasClass("is-act")&&t.indexOf("311")<0&&t.indexOf("112")<0&&(cardsMessage=data.messages.finalFail[18].content,e(cardsMessage,"cardInfo")),t.indexOf("313")>0&&(cardsMessage=data.messages.finalFail[19].content,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&t.indexOf("307")>0&&t.indexOf("304")<0&&t.indexOf("314")<0&&(cardsMessage=data.messages.finalFail[20].content,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&t.indexOf("307")>0&&t.indexOf("301")<0&&(cardsMessage=data.messages.finalFail[21].content,e(cardsMessage,"cardInfo")),t.indexOf("314")>0&&!$("#314").hasClass("is-act")&&(cardsMessage=data.messages.finalFail[22].content,e(cardsMessage,"cardInfo"),t.indexOf("305")<0&&t.indexOf("304")<0&&(cardsMessage=data.messages.finalFail[23].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&(cardsMessage=data.messages.finalFail[24].content,e(cardsMessage,"cardInfo"),t.indexOf("302")<0&&t.indexOf("304")>0&&(cardsMessage=data.messages.finalFail[25].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&t.indexOf("305")>0&&(cardsMessage=data.messages.finalFail[26].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[27].content,e(cardsMessage,"cardInfo")),t.indexOf("204")<0&&(cardsMessage=data.messages.finalFail[28].content,e(cardsMessage,"cardInfo")),t.indexOf("206")<0&&(cardsMessage=data.messages.finalFail[29].content,e(cardsMessage,"cardInfo"))),cardsMessage=data.messages.finalFail[30].content,e(cardsMessage,"cardInfoExtra"))}};