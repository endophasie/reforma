function shuffle(o){for(var e,n,a=o.length;0!==a;)n=Math.floor(Math.random()*a),a-=1,e=o[a],o[a]=o[n],o[n]=e;return o}var data={deck:{101:{type:"economics",title:"Подушная подать",content:"Обложить налогом мужчин всех сословий, кроме дворянства и духовенства",relation:{needs:"102",conflict:"103",union:"102&103",option:"102"},messages:{needs:"Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть.",conflict:"conflictconflictconflictconflictconflictconflict",union:"unionunionunionunionunionunion",option:"optionoptionoption"},failMessage:!1},102:{type:"economics",title:"Подворная подать",content:"Собирать налог не с отдельных представителей податных сословий, а с семьи как хозяйствующего субъекта",relation:{needs:"101",union:"101&103",option:"103"},messages:{needs:"needs2Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть.",conflict:"conflict2222222conflictconflictconflictconflictconflict",union:"union222222unionunionunionunionunion",option:"option222222optionoption"},failMessage:!1},103:{type:"economics",title:"Пропорциональный подоходный налог",content:"Обложить налогом представителей всех сословий без исключения пропорционально их доходам: чем больше доход, тем выше налог",relation:{conflict:"101",union:"102&101",option:"101"},messages:{needs:"needs3Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть.",conflict:"conflic33333333tconflictconflictconflictconflictconflict",union:"union333333unionunionunionunionunion",option:"option33333optionoption"},failMessage:{title:"Конфуз вышел, государь!",content:"Все известные попытки введения пропорционального подоходного налога в условиях сословного общества закончились плачевно. В России они, по счастью, вообще не предпринимались вплоть до Первой мировой войны. Что же касается времен Петра I, служилое сословие по традиции рассматривалось как выплачивающее «налог кровью». Церковь, с некоторыми нюансами, была свободна от налогов еще с татаро-монгольских времен. Возложить дополнительное налоговое бремя на богатых купцов означало удушить оживляющуюся внешнюю торговлю и формирующуюся национальную промышленность. Иными словами, введение подоходного налога – слишком решительный шаг в условиях первой четверти XVIII века, который мог закончиться, чем угодно: бунтом, дворянским заговором, но только не победой в Северной войне."}}},messages:{conflict:[{id:"101102103",content:"Пополнять казну, конечно, можно разными способами, но налоговая система должна базироваться на какой-то одной подати."}],cardactivated:[{id:"1",cardId:"303",comment:"Заработала В3",content:"Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть."}],finalWin:[{id:"1",comment:"Вводное слово",title:"Виктория, государь!",content:"Швед разбит, Россия прочно закрепилась на Балтике, прорублено окно в Европу. Наше вымуштрованное войско, вооруженное по последнему слову военной техники и снабженное всем необходимым, отныне является одним из сильнейших в Европе и мире."}],finalFail:[{id:"1",comment:"Вводное слово",title:"Конфуз вышел, государь!",content:"Как разбить шведа, когда "}]}},Reforma=function(){var o=this,e=data.deck,n=0,a=2,i=[],t=[],s="";o.init=function(){o.reset(),g()},o.reset=function(){console.log("reset",1),n=0,a=2,i=[],t=[],s="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var o=$(".reforma-game_info-message"),e=$(".reforma-game_info-action");o.addClass("is-hide"),e.removeClass("is-hide"),$(".reforma_card").remove(),r(),shuffle(i),c(),l()};var r=function(){var o=$(".reforma-deck_card");for(var n in e){var a="",t=e[n];"economics"==t.type?a+="Экономика":"social"==t.type?a+="Социальная сфера":"war"==t.type&&(a+="Военное дело");var s=$('  <div class="reforma_card '+t.type+'" id="'+n+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+a+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+t.title+'</div>\t\t<div class="reforma_card-text">'+t.content+"</div>  \t </div>  </div>");i.push(n),o.prepend(s)}},c=function(){s=$("#"+i[0]),s.addClass("is-active").siblings(".reforma_card").removeClass("is-active")},l=function(){console.log("setPoints",n);var o=$(".reforma-game_score");o.text(n),n>=100&&k("total-victory")},d=function(o){var e=$(".reforma-game_life");a-=1,console.log("qwe",a),1==a&&(e.eq(1).addClass("is-burn"),x(o)),0==a&&(e.eq(0).addClass("is-burn"),k("total-defeat"))},f=function(o){s.removeClass("is-active"),i.splice(0,1),e[o].failMessage&&d(o),console.log("putOnTable",o);var n=$(".reforma-game_col.is-economy").find(".reforma-game_content"),a=$(".reforma-game_col.is-social").find(".reforma-game_content"),r=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+o).hasClass("economics")?n.prepend($("#"+o)):$("#"+o).hasClass("social")?a.prepend($("#"+o)):$("#"+o).hasClass("war")&&r.prepend($("#"+o)),$("#"+o).addClass("on-desk"),t.push(o),0==i.length&&_()},p=function(o){if(0==t.length)console.log("first or last?",o),f(o);else{var a=e[o].relation,i=e[o].messages,s=!1;if(void 0!=a)for(key in a){var r=m(a[key]),c=u(a[key]),d=i[key];if(r)switch(console.log("relations",key),key){case"needs":b(o,v(c),d),$("#"+o).addClass("is-act"),n+=v(c).length,l(),s=!0;break;case"conflict":w(o,v(c),d),s=!0;break;case"option":n+=1,l()}}s||f(o)}},u=function(o){var e=[],n=/(x|\&|\|)/g;return o.replace(n,",$1").split(/,/g).forEach(function(o){o.length&&(o[0].match(n)?id=o.substr(1):id=o,e.push(id))}),e},m=function(o){if(0==!o.length){var e=!1,n=/(x|\&|\|)/g;return o.replace(n,",$1").split(/,/g).forEach(function(a){console.log(o);var i,t="|";if(a.length){if(a[0].match(n)?(t=a[0],i=a.substr(1)):i=a,"x"==t){var s=h(i);e=e?!s:s}"&"==t&&(e&=h(i)),"|"==t&&(e|=h(i))}}),console.log("result-main",e),e}return!1},v=function(o){return o.filter(function(o){return h(o)})},h=function(o){var e=t.filter(function(e){return e==o});return e.length>0},g=function(){var o=$(".reforma_card");o.on("click",function(){var o=$(this).attr("id");if(console.log("infoPopupData",o),$(this).hasClass("is-act")){var n=u(e[o].relation.needs),a=v(n),i=!0;j(o,a,i),console.log("infoPopupData",o,a,i)}else j(o)});var n=$(".js-act-add"),a=$(".js-act-skip"),t=$(".js-act-remove");n.on("click",function(){var o=s.attr("id");p(o),c()}),a.on("click",function(){i.push(i.splice(0,1)[0]),c()}),t.on("click",function(){i.splice(0,1),c(),0==i.length&&(s.removeClass("is-active"),_())})},_=function(){n>=2&&k("total-victory"),n<1&&k("total-loose")},k=function(o){var e=($(".reforma-game_info-message"),$(".reforma-game_info-action"));$("."+o).removeClass("is-hide"),e.addClass("is-hide"),$(".js-total-score").text(n),$(".js-popup-info-link").on("click",function(){M(o)})},C=function(o){var e=$(".js-overlay"),n=$(".js-popup"),a=$(".js-popup-close");$(".js-popup_content-card");n.addClass("is-hide"),e.removeClass("is-hide"),$("."+o).removeClass("is-hide"),a.on("click",function(){y(o)}),$(document).on("keydown",function(e){27==e.which&&y(o)})},y=function(o){var e=$(".js-overlay"),n=$("."+o)||$(".js-popup"),a=$(".js-popup_content-card"),i=$(".reforma-popup_card-wrap");e.addClass("is-hide"),n.addClass("is-hide"),a.empty(),i.empty()},j=function(o,n,a){var i=$(".card-info").find(".js-popup_content-card"),t=$(".card-info.js-popup"),s=$(".card-info").find(".reforma-popup_card-wrap");C("card-info",a),n=n||[],$("#"+o).clone().removeClass("on-desk").attr("id","").prependTo(i),n.forEach(function(o){$("#"+o).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(s)}),console.log("actPopup",a),a?t.addClass("card-active"):t.removeClass("card-active"),s.find(".reforma_card").on("click",function(){i.empty();var o=$(this).attr("id");if($(this).hasClass("is-act")){var n=u(e[o].relation.needs),a=v(n),t=!0;j(o,a,t)}else j(o)})},w=function(o,e,n){var a=$(".conflict").find(".js-popup_content-card"),i=$(".conflict").find(".js-popup-text");C("conflict"),e=e||[],i.text(n),$("#"+o).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(a),e.forEach(function(o){$("#"+o).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(a)}),$(".conflict").find(".reforma_card").on("click",function(){var o=$(this).attr("id"),e=$(this).siblings(".reforma_card").attr("id"),n=t.indexOf(e);n>-1&&t.splice(n,1),$("#"+e).remove(),c(),y("conflict"),p(o)})},b=function(o,n,a){var i=$(".started-work").find(".js-popup_content-card"),t='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[o].title+'</div>\t  <div class="reforma-popup_par">'+e[o].content+"</div></div>";C("started-work"),n=n||[],i.prepend(t),n.forEach(function(o){var n='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[o].title+'</div>\t  <div class="reforma-popup_par">'+a+"</div></div>";i.prepend(n)}),f(o)},x=function(o){var n=$(".lost-life").find(".js-popup_content-card"),a='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+e[o].failMessage.content+"</div></div>";C("lost-life"),n.prepend(a)},M=function(o){var e,n=$(".finish.js-popup"),a=$(".finish .reforma-popup_title");C("finish"),e="total-loose"==o?"Вы проиграли":"total-defeat"==o?"У вас бунт, государь":"Виктория, государь!",n.addClass(o),a.text(e)}};$(document).ready(function(){var o=$(".js-reforma-start"),e=new Reforma;e.init(),o.on("click",function(o){o.preventDefault(),e.reset()})});