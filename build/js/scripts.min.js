function shuffle(e){for(var a,s,o=e.length;0!==o;)s=Math.floor(Math.random()*o),o-=1,a=e[o],e[o]=e[s],e[s]=a;return e}var data={deck:{101:{type:"economics",title:"Подушная подать",content:"Обложить налогом мужчин всех сословий, кроме дворянства и духовенства",relation:{needs:"102",contras:"103",union:"102&103",option:"102",vasya:"103"},messages:{needs:"messageID",vasya:"Ja Vasya!"},failMessage:!1},102:{type:"economics",title:"Подворная подать",content:"Собирать налог не с отдельных представителей податных сословий, а с семьи как хозяйствующего субъекта",relation:{needs:"101",union:"101&103",option:"103"},failMessage:!1},103:{type:"economics",title:"Пропорциональный подоходный налог",content:"Обложить налогом представителей всех сословий без исключения пропорционально их доходам: чем больше доход, тем выше налог",relation:{contras:"101",union:"102&101",option:"101"},failMessage:{title:"Конфуз вышел, государь!",content:"Все известные попытки введения пропорционального подоходного налога в условиях сословного общества закончились плачевно. В России они, по счастью, вообще не предпринимались вплоть до Первой мировой войны. Что же касается времен Петра I, служилое сословие по традиции рассматривалось как выплачивающее «налог кровью». Церковь, с некоторыми нюансами, была свободна от налогов еще с татаро-монгольских времен. Возложить дополнительное налоговое бремя на богатых купцов означало удушить оживляющуюся внешнюю торговлю и формирующуюся национальную промышленность. Иными словами, введение подоходного налога – слишком решительный шаг в условиях первой четверти XVIII века, который мог закончиться, чем угодно: бунтом, дворянским заговором, но только не победой в Северной войне."}}},messages:{contras:[{id:"101102103",content:"Пополнять казну, конечно, можно разными способами, но налоговая система должна базироваться на какой-то одной подати."}],cardactivated:[{id:"1",cardId:"303",comment:"Заработала В3",content:"Теперь у нас есть и рекруты, годные к воинской службе, и устав, согласно которому эти рекруты будут служить, и офицеры, способные обучить новобранцев военному делу и руководить ими в бою. Наша армия определенно обрела плоть."}],finalWin:[{id:"1",comment:"Вводное слово",title:"Виктория, государь!",content:"Швед разбит, Россия прочно закрепилась на Балтике, прорублено окно в Европу. Наше вымуштрованное войско, вооруженное по последнему слову военной техники и снабженное всем необходимым, отныне является одним из сильнейших в Европе и мире."}],finalFail:[{id:"1",comment:"Вводное слово",title:"Конфуз вышел, государь!",content:"Как разбить шведа, когда "}]}},Reforma=function(){var e=this,a=data.deck,s=0,o=2,r=[],i=[],n="";e.init=function(){e.reset(),g()},e.reset=function(){console.log("reset",1),s=0,o=2,r=[],i=[],n="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var e=$(".reforma-game_info-message"),a=$(".reforma-game_info-action");e.addClass("is-hide"),a.removeClass("is-hide"),$(".reforma_card").remove(),t(),shuffle(r),c(),d()};var t=function(){var e=$(".reforma-deck_card");for(var s in a){var o="",i=a[s];"economics"==i.type?o+="Экономика":"social"==i.type?o+="Социальная сфера":"war"==i.type&&(o+="Военное дело");var n=$('  <div class="reforma_card '+i.type+'" id="'+s+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+o+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+i.title+'</div>\t\t<div class="reforma_card-text">'+i.content+"</div>  \t </div>  </div>");r.push(s),e.prepend(n)}},c=function(){n=$("#"+r[0]),n.addClass("is-active").siblings(".reforma_card").removeClass("is-active")},d=function(){console.log("setPoints",s);var e=$(".reforma-game_score");e.text(s),100==s&&h("finish")},l=function(e){n.removeClass("is-active"),r.splice(0,1),console.log("putOnTable",e);var a=$(".reforma-game_col.is-economy").find(".reforma-game_content"),s=$(".reforma-game_col.is-social").find(".reforma-game_content"),o=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+e).hasClass("economics")?a.prepend($("#"+e)):$("#"+e).hasClass("social")?s.prepend($("#"+e)):$("#"+e).hasClass("war")&&o.prepend($("#"+e)),$("#"+e).addClass("on-desk"),i.push(e)},f=function(e){if(0==i.length)console.log("first or last?",e),l(e);else{var o=a[e].relation,r=!1;if(void 0!=o){for(key in o){var n=p(o[key]),t=m(o[key]);if(console.log(n,t),n)switch(console.log("relations",key),key){case"needs":k("started-work",e,v(t)),s+=v(t).length,d(),r=!0;break;case"contras":k("conflict",e,v(t)),r=!0;break;case"option":s+=1,d()}}var c=a[e].messages;void 0!=c&&console.log("message",c)}r||l(e)}},m=function(e){var a=[],s=/(x|\&|\|)/g;return e.replace(s,",$1").split(/,/g).forEach(function(e){e.length&&(e[0].match(s)?id=e.substr(1):id=e,a.push(id))}),a},p=function(e){if(0==!e.length){var a=!1,s=/(x|\&|\|)/g;return e.replace(s,",$1").split(/,/g).forEach(function(o){console.log(e);var r,i="|";if(o.length){if(o[0].match(s)?(i=o[0],r=o.substr(1)):r=o,"x"==i){var n=u(r);a=a?!n:n}"&"==i&&(a&=u(r)),"|"==i&&(a|=u(r))}}),console.log("result-main",a),a}return!1},v=function(e){return e.filter(function(e){return u(e)})},u=function(e){var a=i.filter(function(a){return a==e});return a.length>0},g=function(){var e=$(".reforma_card");e.on("click",function(){var e=$(this).attr("id");k("card-info",e)});var a=$(".js-act-add"),s=$(".js-act-skip"),o=$(".js-act-remove");a.on("click",function(){var e=n.attr("id");f(e),c()}),s.on("click",function(){r.push(r.splice(0,1)[0]),c()}),o.on("click",function(){r.splice(0,1),c(),0==r.length&&(n.removeClass("is-active"),h())})},h=function(e){s>=100&&_("victory"),s<100&&_("loose"),_(popupType)},_=function(e){var a=$(".reforma-game_info-message"),o=$(".reforma-game_info-action");a.removeClass("is-hide").addClass(e),o.addClass("is-hide"),$(".reforma-game_info-message-score").text(s),$(".js-popup-info-link").on("click",function(){k("finish",e)})},k=function(e,s,o){var r=$(".js-overlay"),n=$(".js-popup"),t=$(".js-popup-close"),d=$(".js-popup_content-card"),f=$(".js-popup-text");if(n.addClass("is-hide"),r.removeClass("is-hide"),$("."+e).removeClass("is-hide"),t.on("click",function(){r.addClass("is-hide"),$("."+e).addClass("is-hide"),d.empty()}),o=o||[],console.log("popupData",s,o),$(document).on("keydown",function(a){27==a.which&&(r.addClass("is-hide"),$("."+e).addClass("is-hide"),d.empty())}),"card-info"==e&&(console.log("this",s),$("#"+s).clone().removeClass("on-desk").attr("id","").prependTo(d)),"conflict"==e&&(f.text(data.messages.contras[0].content),$("#"+s).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(d),o.forEach(function(e){$("#"+e).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(d)}),$("."+e).find(".reforma_card").on("click",function(){var a=$(this).attr("id"),s=$(this).siblings(".reforma_card").attr("id");cardInd=i.indexOf(s),cardInd>-1&&i.splice(cardInd,1),l(a),$("#"+s).remove(),c(),r.addClass("is-hide"),$("."+e).addClass("is-hide"),d.empty(),console.log("conflictClick",$(this))})),"started-work"==e){var m='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[s].title+'</div>\t  <div class="reforma-popup_par">'+data.messages.cardactivated[0].content+"</div></div>";d.prepend(m),o.forEach(function(e){var s='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+a[e].title+'</div>\t  <div class="reforma-popup_par">'+data.messages.cardactivated[0].content+"</div></div>";d.prepend(s)}),l(s)}if("lost-life"==e){var p='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+s+"</div></div>";d.prepend(p)}}};$(document).ready(function(){var e=$(".js-reforma-start"),a=new Reforma;a.init(),e.on("click",function(e){e.preventDefault(),a.reset()})});