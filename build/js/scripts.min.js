function ajax(){return $.getJSON("data.json")}function shuffle(a){for(var e,s,n=a.length;0!==n;)s=Math.floor(Math.random()*n),n-=1,e=a[n],a[n]=a[s],a[s]=e;return a}var data=null;ajax().done(function(a){data=a;var e=$(".js-reforma-start"),s=new Reforma;s.init(),e.on("click",function(a){a.preventDefault(),s.reset()})});var Reforma=function(){var a=this,e=data.deck,s=0,n=2,i=[],t=[],r="",d={active:[],disactive:[],removed:"",clear:function(){this.active.length=0,this.disactive.length=0,this.removed=""}};a.init=function(){a.reset(),I()},a.reset=function(){p("reset",1),s=0,n=2,i=[],t=[],r="",$(".reforma-desk_base").hasClass("is-hide")&&($(".reforma-desk_base").removeClass("is-hide"),$(".reforma-desk_game").addClass("is-hide")),$(".reforma-game_life").removeClass("is-burn"),$(".js-popup_content-card").empty();var a=$(".reforma-game_info-message"),e=$(".reforma-game_info-action");a.addClass("is-hide"),e.removeClass("is-hide"),$(".reforma_card").remove(),$(".reforma-deck_card").removeClass("is-end is-ending is-hide"),o(),shuffle(i),f(),l()};var o=function(){var a=$(".reforma-deck_card");for(var s in e){var n="",t=e[s];"economics"==t.type?n+="Экономика":"social"==t.type?n+="Социальная сфера":"war"==t.type&&(n+="Военное дело");var r=$('  <div class="reforma_card '+t.type+'" id="'+s+'">    <div class="reforma-card_tag"><span class="reforma-card_icon"></span>'+n+'</div>    <div class="reforma_card-content">\t\t<div class="reforma_card-title">'+t.title+'</div>\t\t<div class="reforma_card-text">'+t.content+"</div>  \t </div>  </div>");i.push(s),a.prepend(r)}var d=$(".reforma_card");d.on("click",c)},c=function(){if(p($(this)),$(this).hasClass("on-desk")||$(this).closest(".reforma-popup_card-content")){var a=$(this).attr("id");if(!$(this).hasClass("is-act")||void 0!=e[a].relation&&void 0!=e[a].relation.needs)if($(this).hasClass("is-act")&&void 0!=e[a].relation.needs){var s=!0,n=x(e[a].relation.needs),i=M(n,!0);b(a,s,i)}else b(a);else{var s=!0;b(a,s)}}},f=function(){r=$("#"+i[0]),r.addClass("is-active").siblings(".reforma_card").removeClass("is-active zoomOutLeft zoomOutRight")},l=function(){var a=$(".reforma-game_score");a.text(s)},g=function(a){var e=$(".reforma-game_life");if(n-=1,v(),f(),1==n&&(e.eq(1).addClass("is-burn"),z(a)),0==n){var s=!0;e.eq(0).addClass("is-burn"),z(a,s),y("total-defeat")}},p=function(a,e){var s=[];s.filter(function(e){return e==a}).length>0&&console.log(a+": ",e)},m=function(a){if(r.removeClass("is-active"),e[a].failMessage)return g(a),!1;p("putOnTable",a),O(a)||t.push(a),void 0!=e[a].relation&&void 0!=e[a].relation.needs||$("#"+a).hasClass("is-act")||$("#"+a).addClass("is-act");var s=$(".reforma-game_col.is-economy").find(".reforma-game_content"),n=$(".reforma-game_col.is-social").find(".reforma-game_content"),i=$(".reforma-game_col.is-war").find(".reforma-game_content");$(".reforma-desk_game").hasClass("is-hide")&&($(".reforma-desk_game").removeClass("is-hide"),$(".reforma-desk_base").addClass("is-hide")),$("#"+a).hasClass("economics")?s.prepend($("#"+a)):$("#"+a).hasClass("social")?n.prepend($("#"+a)):$("#"+a).hasClass("war")&&i.prepend($("#"+a)),$("#"+a).addClass("on-desk"),v()},v=function(){if(t.length>1){for(var a=!0;a;)for(var e=0;e<t.length-1&&!(a=u(t[e]));e++);s+=C(),l()}},u=function(a){if(0!=t.length){var n=e[a].relation,i=e[a].messages,r=!1,o=$("#"+a).hasClass("is-act"),c=!1;if(void 0!=n)for(key in n){var f=h(n[key],"conflict"!=key),l=x(n[key]),g=i[key],v=[];if(f){for(j in g)M(l).forEach(function(a){a==j&&v.push(a)});switch(key){case"needs":p("needs",a+e[a].relation.needs+o),o||(T(a,M(l,!0),v),$("#"+a).addClass("is-act"),p("needs",d.active+" "+s+$("#"+a)),d.active.push(a),c=!0);break;case"conflict":p("conflict",a,e[a].relation.conflict),E(a,M(l),v),r=!0;break;case"option":}}else o&&"needs"==key&&(p("needs",a),$("#"+a).removeClass("is-act"),d.disactive.push(a),c=!0)}return r||O(a)||m(a),c}m(a)},x=function(a){if(""==a)return[];var e=[],s=/(x|\&|\|)/g;return a.replace(s,",$1").split(/,/g).forEach(function(a){a.length&&(a[0].match(s)?id=a.substr(1):id=a,e.push(id))}),e},h=function(a,e){if(0==!a.length){var s=!1,n=/(x|\&|\|)/g;return a.replace(n,",$1").split(/,/g).forEach(function(a){var i,t="|";if(a.length)if(a[0].match(n)?(t=a[0],i=a.substr(1)):i=a,e){if("x"==t){var r=_(i);s=s?!r:r}"&"==t&&(s&=_(i)),"|"==t&&(s|=_(i))}else{if("x"==t){var r=O(i);s=s?!r:r}"&"==t&&(s&=O(i)),"|"==t&&(s|=O(i))}}),s}return!1},M=function(a,e){return e?(p("filter",a.filter(function(a){return p("filter",a+" is active = "+_(a)),_(a)})),a.filter(function(a){return _(a)})):a.filter(function(a){return O(a)})},O=function(a){var e=t.filter(function(e){return e==a});return e.length>0},_=function(a){var e=t.filter(function(e){return e==a&&$("#"+e).hasClass("is-act")});return e.length>0},C=function(){var a=0,s=M(t,!0);p("points","calculating points"),p("points",s),p("points",d.active);for(var n in d.active){var i=d.active[n],r=e[i];p("points","count points for "+r+" card, id = "+i),p("points_",r);var o=r.relation.needs+(r.relation.option?"|"+r.relation.option:"");p("points_",o),p("points",x(o)),a+=M(x(o),!0).length,p("points",a);for(var c in s)if(s.indexOf(i)>c){var f=e[s[c]],l=f.relation&&f.relation.needs?f.relation.needs:"",g=f.relation&&f.relation.option?f.relation.option:"";p("points_",l),x(l).indexOf(i)>=0&&(a++,p("points","needs link "+s[c])),x(g).indexOf(i)>=0&&(a++,p("points","option link "+a))}}var m=s.filter(function(a){return d.active.indexOf(a)<0});m=m.concat(d.disactive),console.log("earlyActivated",m,d.disactive),p("points_dis","result "+a);for(var n in d.disactive){var v=d.disactive[n],u=e[v];p("points_dis","decrement points for card = "+v),p("points_dis",u);var l=u.relation&&u.relation.needs?u.relation.needs:"",g=u.relation&&u.relation.option?u.relation.option:"",h=x(l),$=m.filter(function(a){return h.indexOf(a)>=0});p("points_dis",$),a-=$.length;var O=x(g);$=m.filter(function(a){return O.indexOf(a)>=0}),p("points_dis",$),a-=$.length,p("points_dis",a)}return d.clear(),p("points_dis","result "+a),a},I=function(){var a=$(".js-act-add"),e=$(".js-act-skip"),s=$(".js-act-remove"),n=$(".js-reforma-end");a.on("click",function(){i.splice(0,1),k();var a=r.attr("id");u(a),f()}),e.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutLeft"),setTimeout(function(){i.push(i.splice(0,1)[0]),f()},1e3)}),s.on("click",function(){$(".reforma_card.is-active").addClass("zoomOutRight"),setTimeout(function(){i.splice(0,1),f(),k()},700)}),n.on("click",function(){y()})},k=function(){var a=$(".reforma-deck_card");2==i.length?a.addClass("is-ending"):1==i.length?a.addClass("is-end").removeClass("is-ending"):0==i.length&&(r.removeClass("is-active"),a.addClass("is-hide"))},F=function(){var a,e="310x311&312",s=x(e),n=M(s).filter(function(a){if($("#"+a).hasClass("is-act"))return a});return a=h(e)&&n?"total-victory":"total-loose",p("check",n),a},y=function(a){var e=($(".reforma-game_info-message"),$(".reforma-game_info-action"));void 0==a&&(a=F()),$("."+a).removeClass("is-hide"),e.addClass("is-hide"),1==s||21==s||31==s?$(".js-total-score").text(s+" очко"):s>=2&&s<=4?$(".js-total-score").text(s+" очка"):$(".js-total-score").text(s+" очков"),$(".js-popup-info-link").on("click",function(){R(a)})},W=function(a){var e=$(".js-overlay"),s=$(".js-popup"),n=$(".js-popup-close");$(".js-popup_content-card");s.addClass("is-hide"),e.removeClass("is-hide"),$("."+a).removeClass("is-hide"),n.on("click",function(){w(a)}),$(document).on("keydown",function(e){27==e.which&&w(a)})},w=function(a){var e=$(".js-overlay"),s=$("."+a)||$(".js-popup"),n=$(".js-popup_content-card"),i=$(".reforma-popup_card-wrap");e.addClass("is-hide"),s.addClass("is-hide"),n.empty(),i.empty()},b=function(a,e,s){var n=$(".card-info").find(".js-popup_content-card"),i=$(".card-info.js-popup"),t=$(".card-info").find(".reforma-popup_card-wrap");n.empty(),t.empty(),W("card-info",e),s=s||[],$("#"+a).clone().removeClass("on-desk").attr("id","").prependTo(n),s.forEach(function(a){$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(t)}),e?i.addClass("card-active"):i.removeClass("card-active"),s.length>0?i.addClass("card-active-cards"):i.removeClass("card-active-cards"),t.find(".reforma_card").on("click",c)},E=function(a,s,n){var i=$(".conflict").find(".js-popup_content-card"),r=$(".conflict").find(".js-popup-text");W("conflict"),n.forEach(function(s){var n=e[a].messages.conflict[s];r.text(data.content[n])}),$("#"+a).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i),s[0]&&$("#"+s[0]).clone().removeClass("on-desk").addClass("reforma-deck_card").prependTo(i),$(".conflict").find(".reforma_card").on("click",function(){var a=$(this).attr("id"),e=$(this).siblings(".reforma_card").attr("id"),s=t.indexOf(e);s>-1&&(t.splice(s,1),d.removed=s),$("#"+e).remove(),d.disactive.push(e),w("conflict"),m(a),f()})},T=function(a,s,n){var i;n.forEach(function(s){var n=e[a].messages.needs[s];i=data.content[n]});var t=$(".started-work").find(".js-popup_content-card"),r='<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+i+"</div></div>";W("started-work"),t.append(r),s=s||[],s.forEach(function(a){'<div class="reforma-popup_wrap">    <div class="reforma-popup_par-extra">'+e[a].title+'</div>\t  <div class="reforma-popup_par">'+i+"</div></div>"})},z=function(a,s){var n=$(".lost-life").find(".js-popup_content-card"),i='<div class="reforma-popup_wrap">\t  <div class="reforma-popup_par">'+e[a].failMessage.content+"</div></div>";W("lost-life"),n.prepend(i),s?n.next(".reforma-popup_par.is-info").addClass("is-hide"):n.next(".reforma-popup_par.is-info").removeClass("is-hide")},R=function(a){function e(a,e){p(e),e='<div class="reforma-popup_par">'+a+"</div>",p("simple"),r.append(e)}var s,n=$(".finish.js-popup"),i=$(".finish .reforma-popup_title"),r=n.find(".reforma-popup_wrap");W("finish"),s="total-loose"==a?"Вы проиграли":"total-defeat"==a?"У вас бунт, государь":"Виктория, государь!",n.addClass(a),i.text(s),"total-victory"==a?t.indexOf("303")>0&&t.indexOf("312")>0&&(t.indexOf("310")>0||t.indexOf("311")>0)?(cardsMessage=data.messages.finalWin[0].content,e(cardsMessage,"cardInfo")):(cardsMessage=data.messages.finalWin[1].content,e(cardsMessage,"cardInfoExtra"),t.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[2].content,e(cardsMessage,"cardInfo")),t.indexOf("108")>0&&t.indexOf("210")<0&&(cardsMessage=data.messages.finalWin[3].content,e(cardsMessage,"cardInfo")),(t.indexOf("106")<0||t.indexOf("109")>0)&&(cardsMessage=data.messages.finalWin[4].content,e(cardsMessage,"cardInfo")),t.indexOf("111")>0&&t.indexOf("210")<0&&t.indexOf("211")<0&&(cardsMessage=data.messages.finalWin[5].content,e(cardsMessage,"cardInfo")),t.indexOf("311")>0&&t.indexOf("310")<0&&(cardsMessage=data.messages.finalWin[6].content,e(cardsMessage,"cardInfo")),t.indexOf("311")>0&&t.indexOf("310")>0&&(cardsMessage=data.messages.finalWin[7].content,e(cardsMessage,"cardInfo")),t.indexOf("211")>0&&(cardsMessage=data.messages.finalWin[8].content,e(cardsMessage,"cardInfo")),t.indexOf("209")>0&&(cardsMessage=data.messages.finalWin[9].content,e(cardsMessage,"cardInfo")),(t.indexOf("110")<0||t.indexOf("111")<0)&&(cardsMessage=data.messages.finalWin[10].content,e(cardsMessage,"cardInfo")),t.indexOf("110")<0&&t.indexOf("111")>0&&(cardsMessage=data.messages.finalWin[11].content,e(cardsMessage,"cardInfo")),t.indexOf("111")<0&&t.indexOf("110")>0&&(cardsMessage=data.messages.finalWin[12].content,e(cardsMessage,"cardInfo")),t.indexOf("304")>0&&(cardsMessage=data.messages.finalWin[13].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&(cardsMessage=data.messages.finalWin[14].content,e(cardsMessage,"cardInfo")),t.indexOf("208")<0&&(cardsMessage=data.messages.finalWin[15].content,e(cardsMessage,"cardInfo")),t.indexOf("104")>0&&t.indexOf("107")<0&&(cardsMessage=data.messages.finalWin[16].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalWin[17].content,e(cardsMessage,"cardInfoExtra")):"total-loose"==a&&(cardsMessage=data.messages.finalFail[0].content,e(cardsMessage,"cardInfo"),t.indexOf("303")<0?(cardsMessage=data.messages.finalFail[1].content,e(cardsMessage,"cardInfo")):t.indexOf("312")<0?(cardsMessage=data.messages.finalFail[3].content,e(cardsMessage,"cardInfo")):t.indexOf("310")<0&&t.indexOf("311")<0&&(cardsMessage=data.messages.finalFail[2].content,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&!$("#303").hasClass("is-act")&&(t.indexOf("306")>0&&(cardsMessage=data.messages.finalFail[4].content,e(cardsMessage,"cardInfo")),t.indexOf("307")<0&&t.indexOf("306")<0&&(cardsMessage=data.messages.finalFail[5].content,e(cardsMessage,"cardInfo"))),t.indexOf("312")>0&&!$("#312").hasClass("is-act")&&t.indexOf("101")<0&&(cardsMessage=data.messages.finalFail[6].content,e(cardsMessage,"cardInfo"),t.indexOf("101")<0&&t.indexOf("102")<0&&(cardsMessage=data.messages.finalFail[7].content,e(cardsMessage,"cardInfo")),t.indexOf("101")<0&&t.indexOf("102")>0&&(cardsMessage=data.messages.finalFail[8].content,e(cardsMessage,"cardInfo"))),t.indexOf("202")>0&&!$("#202").hasClass("is-act")&&(t.indexOf("107")<0&&t.indexOf("106")<0&&t.indexOf("311")<0&&(cardsMessage=data.messages.finalFail[9].content,e(cardsMessage,"cardInfo")),($("#106").hasClass("is-act")?!$("#107").hasClass("is-act"):$("#107").hasClass("is-act"))&&t.indexOf("202")<0&&(cardsMessage=data.messages.finalFail[10].content,e(cardsMessage,"cardInfo")),$("#106").hasClass("is-act")&&t.indexOf("107")<0&&(cardsMessage=data.messages.finalFail[11].content,e(cardsMessage,"cardInfo")),t.indexOf("106")>0&&t.indexOf("210")<0&&(cardsMessage=data.messages.finalFail[12].content,e(cardsMessage,"cardInfo")),t.indexOf("107")>0&&t.indexOf("106")<0&&t.indexOf("101")<0&&t.indexOf("110")<0&&(t.indexOf("111")<0||!$("#107").hasClass("is-act"))&&(cardsMessage=data.messages.finalFail[13].content,e(cardsMessage,"cardInfo"),t.indexOf("102")>0&&t.indexOf("312")<0&&(cardsMessage=data.messages.finalFail[14].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[15].content,e(cardsMessage,"cardInfo")),t.indexOf("111")>0&&t.indexOf("101")<0&&t.indexOf("110")<0&&(cardsMessage=data.messages.finalFail[16].content,e(cardsMessage,"cardInfo"))),t.indexOf("311")>0&&!$("#311").hasClass("is-act")&&t.indexOf("310")<0&&t.indexOf("105")<0&&(cardsMessage=data.messages.finalFail[17].content,e(cardsMessage,"cardInfo")),t.indexOf("310")>0&&!$("#310").hasClass("is-act")&&$("#202").hasClass("is-act")&&t.indexOf("311")<0&&t.indexOf("112")<0&&(cardsMessage=data.messages.finalFail[18].content,e(cardsMessage,"cardInfo")),t.indexOf("313")>0&&(cardsMessage=data.messages.finalFail[19].content,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&t.indexOf("307")>0&&t.indexOf("304")<0&&t.indexOf("314")<0&&(cardsMessage=data.messages.finalFail[20].content,e(cardsMessage,"cardInfo")),t.indexOf("303")>0&&t.indexOf("307")>0&&t.indexOf("301")<0&&(cardsMessage=data.messages.finalFail[21].content,e(cardsMessage,"cardInfo")),t.indexOf("314")>0&&!$("#314").hasClass("is-act")&&(cardsMessage=data.messages.finalFail[22].content,e(cardsMessage,"cardInfo"),t.indexOf("305")<0&&t.indexOf("304")<0&&(cardsMessage=data.messages.finalFail[23].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&(cardsMessage=data.messages.finalFail[24].content,e(cardsMessage,"cardInfo"),t.indexOf("302")<0&&t.indexOf("304")>0&&(cardsMessage=data.messages.finalFail[25].content,e(cardsMessage,"cardInfo")),t.indexOf("302")<0&&t.indexOf("305")>0&&(cardsMessage=data.messages.finalFail[26].content,e(cardsMessage,"cardInfo")),cardsMessage=data.messages.finalFail[27].content,e(cardsMessage,"cardInfo")),t.indexOf("204")<0&&(cardsMessage=data.messages.finalFail[28].content,e(cardsMessage,"cardInfo")),t.indexOf("206")<0&&(cardsMessage=data.messages.finalFail[29].content,e(cardsMessage,"cardInfo"))))}};